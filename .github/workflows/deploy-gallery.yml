name: Run Shell Script

on:
  workflow_call:
    inputs:
      compute_gallery_rg:
        required: true
        type: string
        description: Resource group of the destination compute gallery.
      compute_gallery:
        required: true
        type: string
        description: Name of the destination compute gallery.
      image_definition:
        required: true
        type: string
        description: Name of the destination image definition.
      client_id:
        required: true
        type: string
        description: Azure service principal client ID.
      tenant_id:
        type: string
        description: Azure service princiapl teanant ID.
      subscription_id:
        required: true
        type: string
        description:  Azure service princiapl subscription ID.
    secrets:
      client_secret:
        required: true
        description: Azure service principal client secret.

env:
  ARM_CLIENT_ID: ${{ inputs.client_id }}
  ARM_CLIENT_SECRET: ${{ secrets.client_secret }}
  ARM_TENANT_ID: ${{ inputs.tenant_id }}
  ARM_SUBSCRIPTION_ID: ${{ inputs.subscription_id }}
  TF_VAR_rg: ${{ inputs.compute_gallery_rg }}
  TF_VAR_shared_gallery: ${{ inputs.compute_gallery }}
  TF_VAR_image_definition: ${{ inputs.image_definition }}
  WD: called/shell-script

jobs:
  build:
    name: Call Shell Script
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.WD }}
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: caller

      - name: Checkout shared-workflows repository
        uses: actions/checkout@v4
        with:
          repository: packer-builds-shared-workflows
          path: called

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ inputs.client_id }}","clientSecret":"${{ secrets.client_secret }}","subscriptionId":"${{ inputs.subscription_id }}","tenantId":"${{ inputs.tenant_id }}"}' 
  
      - name: Create Resource Group, Shared Image Gallery and Shared Image Definition
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            echo "Running the azure resources provisioning script"
            chmod +x image-gallery.sh
            ./image-gallery.sh ${{ inputs.compute_gallery_rg }} ${{ inputs.compute_gallery }} ${{ inputs.image_definition }}